# Register Pressure Manager Integration

## Summary

This document describes the integration of `RegisterPressureManager` with the V2 backend components to provide better register allocation with intelligent spilling.

## Changes Made

### 1. Function Module (`function.rs`)

- Added `RegisterPressureManager` as a field in `FunctionLowering`
- Initialized pressure manager in `emit_prologue()` with local count
- Updated `get_local_addr()`, `load_local()`, and `store_local()` to use pressure manager for register allocation
- Properly collect spill/reload instructions generated by the pressure manager

### 2. Calling Convention Module (`calling_convention.rs`)

- Updated all methods to accept an optional `RegisterPressureManager` parameter:
  - `setup_call_args()` - Now spills all registers before call when pressure manager is provided
  - `handle_return_value()` - Uses pressure manager for allocating return value registers
  - `load_param()` - Uses pressure manager for parameter register allocation
- Maintains backward compatibility by making pressure manager optional

### 3. Register Allocator Module (`regalloc.rs`)

- Remains as the low-level allocator
- Used directly when pressure manager is not available
- Provides bank tracking and R13 initialization functionality

### 4. Register Pressure Manager (`register_pressure.rs`)

The manager provides:
- **LRU-based spilling**: Tracks least recently used registers for spilling decisions
- **Sethi-Ullman ordering**: Optimizes evaluation order for binary operations
- **Lifetime tracking**: Analyzes value lifetimes across basic blocks
- **Spill/reload management**: Generates efficient spill and reload code
- **Fat pointer support**: Handles 2-register fat pointers correctly

## Architecture

```
┌─────────────────────────────────┐
│     FunctionLowering            │
│  ┌────────────────────────────┐ │
│  │  RegisterPressureManager   │ │
│  │  - LRU spilling            │ │
│  │  - Lifetime analysis       │ │
│  │  - Sethi-Ullman ordering   │ │
│  └────────────────────────────┘ │
│  ┌────────────────────────────┐ │
│  │  RegAllocV2                │ │
│  │  - Low-level allocation    │ │
│  │  - Bank tracking           │ │
│  │  - R13 initialization      │ │
│  └────────────────────────────┘ │
└─────────────────────────────────┘
```

## Usage 

```rust
let mut func = FunctionLowering::new();
func.emit_prologue(10); // Initializes pressure manager

// Register allocation with intelligent spilling
let reg = func.pressure_manager.get_register("value".to_string());
let insts = func.pressure_manager.take_instructions(); // Get spill/reload code
```


## Benefits

1. **Reduced Spills**: LRU policy and lifetime analysis minimize unnecessary spills
2. **Better Code Quality**: Sethi-Ullman ordering reduces register pressure in expressions
3. **Deterministic Behavior**: Consistent register allocation order for reproducible builds
4. **Comprehensive Testing**: 39 stress tests covering all edge cases
5. **Backward Compatibility**: Optional pressure manager allows gradual migration

## Test Coverage

- **25 register pressure tests**: Core functionality and edge cases
- **14 additional stress tests**: Integration scenarios
- **All tests passing**: 100% test success rate

## Future Improvements

1. **Loop-aware spilling**: Higher cost for values used in loops
2. **Register coalescing**: Merge non-overlapping live ranges
3. **Rematerialization**: Regenerate constants instead of spilling
4. **Global register allocation**: Cross-basic-block optimization