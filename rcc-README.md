# Ripple C99 Compiler (rcc)

A C99 freestanding compiler targeting the Ripple VM ISA, built with Rust using a backend-first approach.

## Project Status: M1 - Backend Skeleton

Currently implementing the foundational backend components for code generation:

- ✅ **Workspace Setup**: Multi-crate Rust workspace
- ✅ **ISA Emitter**: Ripple assembly instruction definitions
- ✅ **ABI Implementation**: Calling conventions, stack frames
- ✅ **Register Allocation**: Simple linear scan allocator
- ✅ **Assembly Emission**: Text output for rasm assembler
- ✅ **Minimal IR**: Simple IR for testing backend
- ✅ **IR Lowering**: Translation from IR to assembly
- ✅ **Driver**: Command-line interface for testing

## Architecture

```
rcc-driver    - Main compiler binary and CLI
rcc-codegen   - Assembly generation, ABI, register allocation  
rcc-ir        - Intermediate representation and lowering
rcc-common    - Shared types, errors, utilities
```

## Quick Start

```bash
# Build the project
cargo build

# Run hello world test
cargo run --bin rcc test --test-name hello

# Run arithmetic test  
cargo run --bin rcc test --test-name arithmetic

# Generate assembly to file
cargo run --bin rcc test --test-name hello --output hello.asm

# Run all tests
cargo test
```

## Example Output

The hello world test generates IR like:

```
; Hello World program
main:
t0 = 72      ; 'H'
t1 = 0       ; bank
t2 = 0       ; addr  
store t0 to [t1][t2]
t3 = 105     ; 'i'
store t3 to [t1][t2]
return
```

Which compiles to Ripple assembly:

```assembly
; Generated by Ripple C99 Compiler (rcc)

; Program entry point
_start:
    CALL main
    HALT

; Hello World program  
main:
    LI R3, 72
    LI R4, 0
    LI R5, 0
    STORE R3, R4, R5
    LI R6, 105  
    STORE R6, R4, R5
    LI R7, 10
    STORE R7, R4, R5
    RET
```

## Testing

Each crate has comprehensive unit tests:

```bash
# Test individual crates
cargo test -p rcc-codegen
cargo test -p rcc-ir
cargo test -p rcc-common

# Test everything
cargo test
```

## Development

The project follows test-driven development. Key test files:

- `rcc-codegen/src/asm.rs` - Instruction formatting tests
- `rcc-codegen/src/abi.rs` - ABI and calling convention tests  
- `rcc-codegen/src/regalloc.rs` - Register allocation tests
- `rcc-ir/src/lowering.rs` - IR to assembly lowering tests

## Next Steps (M2)

- [ ] Lexer for C99 tokens
- [ ] Parser for C expressions and statements  
- [ ] AST definitions
- [ ] Type system
- [ ] Full IR design
- [ ] AST to IR lowering

## Integration

The compiler integrates with the existing Ripple toolchain:

1. `rcc` generates `.asm` files
2. `rasm` assembles to `.pobj` object files
3. `rlink` links to final binary

This backend-first approach ensures solid code generation before tackling the complexity of C99 parsing and semantic analysis.